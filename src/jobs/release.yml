description: >
  Runs the commands to Release a Maven / Java Gravitee Component

executor: cicdmachine

parameters:
  dry_run:
    type: boolean
    default: true
    description: "Run in dry run mode?"
  maven_container_image_tag:
    type: string
    default: "stable-latest"
    description: "What version of the maven container image should be used? (example : '3.6.3-openjdk-11')"
  maven_profile_id:
    type: string
    default: "gravitee-dry-run"
    description: "What is the maven ID of the maven profile to use ?"
  secrethub_org:
    type: string
    default: $SECRETHUB_ORG
    description: "The name of the Secrethub Org from which Secrets have to be fetched. Its value defaults to the [SECRETHUB_ORG] env variable if set in the Circle CI context"
  secrethub_repo:
    type: string
    default: $SECRETHUB_REPO
    description: "The name of the Secrethub Repo from which Secrets have to be fetched. Its value defaults to the [SECRETHUB_REPO] env variable if set in the Circle CI context"
steps:
  - checkout
  - secrethub/install
  - docker/install-docker-compose
  # - mvn_verify
  # - mvn_build
  - mvn_prepare_release:
      dry_run: << parameters.dry_run >>
      maven_container_image_tag: << parameters.maven_container_image_tag >>
      maven_profile_id: <<parameters.maven_profile_id>>
      secrethub_org: << parameters.secrethub_org >>
      secrethub_repo: << parameters.secrethub_repo >>
  - mvn_test_release:
      dry_run: << parameters.dry_run >>
      maven_container_image_tag: << parameters.maven_container_image_tag >>
      maven_profile_id: <<parameters.maven_profile_id>>
      secrethub_org: << parameters.secrethub_org >>
      secrethub_repo: << parameters.secrethub_repo >>
  - mvn_release:
      dry_run: << parameters.dry_run >>
      maven_container_image_tag: << parameters.maven_container_image_tag >>
      maven_profile_id: <<parameters.maven_profile_id>>
      secrethub_org: << parameters.secrethub_org >>
      secrethub_repo: << parameters.secrethub_repo >>
  - git_release:
      dry_run: << parameters.dry_run >>
      maven_container_image_tag: << parameters.maven_container_image_tag >>
      maven_profile_id: <<parameters.maven_profile_id>>
      secrethub_org: << parameters.secrethub_org >>
      secrethub_repo: << parameters.secrethub_repo >>
