description: >
  This example demonstrates how to use the 4 release process `Orb` Commands, in a Gravitee.io Software Developement repo's Pipeline :
    * "`mvn_prepare_release`"
    * "`mvn_test_release`"
    * "`mvn_release`"
    * "`git_release`"

usage:
  version: 2.1

  parameters:
    gio_action:
      type: enum
      enum: [release, pr_build]
      default: pr_build
    dry_run:
      type: boolean
      default: true
      description: "Run in dry run mode ?"
    maven_container_image_tag:
      type: string
      default: "stable-latest"
      description: "What version of the maven container image should be used? (example : '3.6.3-openjdk-11')"
    maven_profile_id:
      type: string
      default: "gravitee-dry-run"
      description: "Maven ID of the Maven profile to use ?"
    secrethub_org:
      type: string
      default: "gravitee-lab"
      description: "SecretHub Org to use to fetch secrets ?"
    secrethub_repo:
      type: string
      default: "cicd"
      description: "SecretHub Repo to use to fetch secrets ?"

  orbs:
    secrethub: secrethub/cli@1.0.0
    docker: circleci/docker@1.5
    gravitee: gravitee-io/gravitee@dev:1.0.2

  jobs:
    mvn_deploy_gravitee_parent:
      machine:
        resource_class: medium
        image: 'ubuntu-1604:201903-01'    # recommended linux image - includes Ubuntu 16.04, docker 18.09.3, docker-compose 1.23.1
        # docker_layer_caching: true    # default - false # requires a Circle CI plan that includes [Docker layer caching feature]
      steps:
        # I do not checkout the source code of
        # the [clever-cloud-artifactory-deployment-prototype] git repo, but the
        # https://github.com/gravitee-lab/gravitee-parent repo
        # -
        # - checkout
        - run:
            name: "Redefine Gravitee Parent POM in reference private maven repository"
            command: |
                      git clone https://github.com/gravitee-lab/gravitee-parent ./
                      git checkout 17.x
        - secrethub/install
        - docker/install-docker-compose
        - gravitee/mvn_prepare_release:
            dry_run: << parameters.dry_run >>
            maven_container_image_tag: << parameters.maven_container_image_tag >>
            maven_profile_id: <<parameters.maven_profile_id>>
            secrethub_org: << parameters.secrethub_org >>
            secrethub_repo: << parameters.secrethub_repo >>
        - gravitee/mvn_test_release:
            dry_run: << parameters.dry_run >>
            maven_container_image_tag: << parameters.maven_container_image_tag >>
            maven_profile_id: <<parameters.maven_profile_id>>
            secrethub_org: << parameters.secrethub_org >>
            secrethub_repo: << parameters.secrethub_repo >>
        - gravitee/mvn_release:
            dry_run: << parameters.dry_run >>
            maven_container_image_tag: << parameters.maven_container_image_tag >>
            maven_profile_id: <<parameters.maven_profile_id>>
            secrethub_org: << parameters.secrethub_org >>
            secrethub_repo: << parameters.secrethub_repo >>
        - gravitee/git_release:
            dry_run: << parameters.dry_run >>
            maven_container_image_tag: << parameters.maven_container_image_tag >>
            maven_profile_id: <<parameters.maven_profile_id>>
            secrethub_org: << parameters.secrethub_org >>
            secrethub_repo: << parameters.secrethub_repo >>

    mvn_deploy_gravitee_component:
      machine:
        resource_class: medium
        image: 'ubuntu-1604:201903-01'    # recommended linux image - includes Ubuntu 16.04, docker 18.09.3, docker-compose 1.23.1
        # docker_layer_caching: true    # default - false # requires a Circle CI plan that includes [Docker layer caching feature]
      steps:
        # I do not checkout the source code of
        # the [clever-cloud-artifactory-deployment-prototype] git repo, but the
        # https://github.com/gravitee-lab/gravitee-common repo
        # - checkout
        - run:
            name: "Checking out source code of the Gravitee Component, on the deisred version : last commit on the [1.18.x] git branch"
            command: |
                      git clone https://github.com/gravitee-lab/gravitee-common ./
                      git checkout 1.18.x
        - secrethub/install
        - docker/install-docker-compose
        - gravitee/mvn_prepare_release:
            dry_run: << parameters.dry_run >>
            maven_container_image_tag: << parameters.maven_container_image_tag >>
            maven_profile_id: <<parameters.maven_profile_id>>
            secrethub_org: << parameters.secrethub_org >>
            secrethub_repo: << parameters.secrethub_repo >>
        - gravitee/mvn_test_release:
            dry_run: << parameters.dry_run >>
            maven_container_image_tag: << parameters.maven_container_image_tag >>
            maven_profile_id: <<parameters.maven_profile_id>>
            secrethub_org: << parameters.secrethub_org >>
            secrethub_repo: << parameters.secrethub_repo >>
        - gravitee/mvn_release:
            dry_run: << parameters.dry_run >>
            maven_container_image_tag: << parameters.maven_container_image_tag >>
            maven_profile_id: <<parameters.maven_profile_id>>
            secrethub_org: << parameters.secrethub_org >>
            secrethub_repo: << parameters.secrethub_repo >>
        - gravitee/git_release:
            dry_run: << parameters.dry_run >>
            maven_container_image_tag: << parameters.maven_container_image_tag >>
            maven_profile_id: <<parameters.maven_profile_id>>
            secrethub_org: << parameters.secrethub_org >>
            secrethub_repo: << parameters.secrethub_repo >>

  workflows:
    version: 2.1
    maven_deploy:
      # triggers:
        # - schedule:
            # Every sunday at midnight UTC
            # cron: "0 0 * * *"
            # not supported by Circle CI
            # cron: "*/5 * * * *"
            # cron: '* * * * *'
            # Every hour UTC
            # cron: "0 * * * *"
            # filters:
              # branches:
                # only:
                  # - master
      jobs:
        - mvn_deploy_gravitee_parent:
            context: cicd-orchestrator
        - mvn_deploy_gravitee_component:
            context: cicd-orchestrator
            requires:
              - mvn_deploy_gravitee_parent
