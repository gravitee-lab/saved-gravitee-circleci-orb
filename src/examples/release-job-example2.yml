description: >
  This example demonstrates how to use the "`release`" `Orb` Job, in a Gravitee.io Software Developement repo's Pipeline, along with an additional explicit Job.

usage:
  version: 2.1

  parameters:
    gio_action:
      type: enum
      enum: [release, pr_build]
      default: pr_build
    dry_run:
      type: boolean
      default: true
      description: "Run in dry run mode?"
    maven_profile_id:
      type: string
      default: "gravitee-dry-run"
      description: "Maven ID of the Maven profile to use for a dry run ?"
    secrethub_org:
      type: string
      default: "gravitee-lab"
      description: "SecretHub Org to use to fetch secrets ?"
    secrethub_repo:
      type: string
      default: "cicd"
      description: "SecretHub Repo to use to fetch secrets ?"

  orbs:
    gravitee: gravitee-io/gravitee@dev:1.0.4

  jobs:
    some_explicit_job:
      machine:
        resource_class: medium
        image: 'ubuntu-1604:201903-01'    # recommended linux image - includes Ubuntu 16.04, docker 18.09.3, docker-compose 1.23.1
        # docker_layer_caching: true    # default - false # requires a Circle CI plan that includes [Docker layer caching feature]
      steps:
        - checkout
        - run:
            name: "Some Explicit Circle CI Pipeline Job defintion"
            command: |
                      echo "Checking context variables from [cicd-orchestrator] context"
                      echo "DRY_RUN=[$DRY_RUN]"
                      echo "MAVEN_PROFILE_ID=[${MAVEN_PROFILE_ID}]"
                      echo "SECRETHUB_ORG=[${SECRETHUB_ORG}]"
                      echo "SECRETHUB_REPO=[${SECRETHUB_REPO}]"

  workflows:
    version: 2.1
    pull_requests:
      when:
        equal: [ pr_build, << pipeline.parameters.gio_action >> ]
      jobs:
        - gravitee/pr-build:
            context: cicd-orchestrator
    release:
      # see https://circleci.com/docs/2.0/configuration-reference/#logic-statement-examples
      when:
        and:
          - equal: [ release, << pipeline.parameters.gio_action >> ]
          - not: << pipeline.parameters.dry_run >>
      jobs:
        # return to simple definition :
        - gravitee/release:
            context: cicd-orchestrator
            dry_run: << pipeline.parameters.dry_run >>
            secrethub_org: << pipeline.parameters.secrethub_org >>
            secrethub_repo: << pipeline.parameters.secrethub_repo >>
            maven_profile_id: << pipeline.parameters.maven_profile_id >>
    release_dry_run:
      # see https://circleci.com/docs/2.0/configuration-reference/#logic-statement-examples
      when:
        and:
          - equal: [ release, << pipeline.parameters.gio_action >> ]
          - << pipeline.parameters.dry_run >>
      jobs:
        - some_explicit_job:
            context: cicd-orchestrator
        # return to simple definition :
        - gravitee/release:
            context: cicd-orchestrator
            requires:
              - some_explicit_job
            dry_run: << pipeline.parameters.dry_run >>
            secrethub_org: << pipeline.parameters.secrethub_org >>
            secrethub_repo: << pipeline.parameters.secrethub_repo >>
            maven_profile_id: << pipeline.parameters.maven_profile_id >>
